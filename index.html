<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>CEEC 英漢翻譯單字卡（行動版）</title>
<style>
  :root{
    --bg:#f4e6c9;        /* 米色背景 */
    --panel:#f2dfbb;     /* 面板 */
    --card:#fffaf1;      /* 卡片白 */
    --text:#4a2e20;      /* 深咖啡 */
    --muted:#876a59;
    --btn:#ead4ac;
    --btn-2:#e5cfa4;
    --ring:#d4b27e;
    --shadow:0 8px 30px rgba(0,0,0,.07);
    --radius:18px;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Hiragino Sans GB","Microsoft JhengHei",sans-serif;}
  .wrap{max-width:960px;margin:0 auto;padding:16px 14px 80px;}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .topbar{margin-bottom:14px}
  .input,select,button{font-size:16px;border:0;border-radius:12px;background:#fff4df;color:var(--text);padding:12px 14px;box-shadow:var(--shadow);outline: none}
  .select{position:relative}
  .checkbox{display:flex;align-items:center;gap:8px}
  .panel{background:var(--panel);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow)}
  .card{
    background:var(--card);border-radius:22px;box-shadow:var(--shadow);
    min-height:58vh;display:flex;flex-direction:column;justify-content:center;align-items:center;
    position:relative;overflow:hidden;padding:28px 20px;transition:transform .15s;
  }
  .card:active{transform:scale(.995)}
  .counter{position:absolute;left:16px;top:12px;font-weight:600;color:var(--muted)}
  .starBtn{
    position:absolute;right:14px;top:12px;
    background:transparent;border:none;font-size:24px;line-height:1;cursor:pointer;color:#b68a4a;
  }
  .word{font-size:42px;font-weight:800;letter-spacing:.5px;text-align:center;margin:0 0 12px}
  .kk{font-family: "Noto Sans", "Noto Sans TC", system-ui; font-size:18px;color:#7b5b4b;margin:0 0 8px}
  .def{font-size:18px;text-align:center;line-height:1.6}
  .tapHint{position:absolute;bottom:14px;color:#a88a76;font-size:13px}
  .sliderRow{display:flex;align-items:center;gap:10px;margin:12px 0 2px}
  .pill{background:var(--btn);padding:8px 12px;border-radius:999px;font-weight:700;min-width:56px;text-align:center;color:#6a4d3b}
  input[type="range"]{width:100%}
  .btnbar{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
  .btn{background:var(--btn);border:0;border-radius:14px;padding:12px 18px;font-weight:700;box-shadow:var(--shadow);color:#6a4d3b}
  .btn:active{transform:translateY(1px)}
  .starsBoard{margin-top:14px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .tab{background:var(--btn-2);border:0;border-radius:999px;padding:8px 14px;font-weight:700;color:#6a4d3b;opacity:.7}
  .tab.active{opacity:1;outline:2px solid var(--ring)}
  .starList{display:flex;flex-direction:column;gap:10px;max-height:40vh;overflow:auto}
  .starItem{background:var(--card);border-radius:14px;padding:12px 14px;box-shadow:var(--shadow)}
  .starItem b{font-size:18px}
  .muted{color:#8f7766}
  .hidden{display:none}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  /* Mobile tweaks */
  @media (max-width:480px){
    .word{font-size:38px}
    .card{min-height:56vh}
  }
</style>
</head>
<body>
  <div class="wrap">
    <!-- Top controls -->
    <div class="panel topbar">
      <div class="row">
        <input id="q" class="input" placeholder="搜尋 英/中/詞性/KK…" />
        <div class="select">
          <select id="deck" class="input">
            <option value="L1">CEEC Level 1</option>
            <option value="L2">CEEC Level 2</option>
            <option value="L3">CEEC Level 3</option>
            <option value="L4">CEEC Level 4</option>
            <option value="L5">CEEC Level 5</option>
            <option value="L6">CEEC Level 6</option>
            <option value="EXAM">學測單字</option>
          </select>
        </div>
        <label class="checkbox"><input type="checkbox" id="onlyStar"/><span>只看加星</span></label>
      </div>
    </div>

    <!-- Card -->
    <div class="panel">
      <div id="card" class="card" role="button" aria-label="點擊切換翻譯">
        <div id="counter" class="counter">1 / 1</div>
        <button id="starBtn" class="starBtn" title="加星/移除">☆</button>
        <h1 id="word" class="word">loading…</h1>
        <div id="kk" class="kk hidden">[kk]</div>
        <div id="def" class="def hidden">中文＋詞性</div>
        <div class="tapHint">點擊卡片可切換「只看英文 / 顯示翻譯」</div>
      </div>

      <!-- Slider -->
      <div class="sliderRow">
        <span id="idxL" class="pill">1</span>
        <input id="slider" type="range" min="1" max="1" step="1" />
        <span id="idxR" class="pill">1</span>
      </div>

      <!-- Buttons -->
      <div class="btnbar">
        <button id="prev" class="btn">← 上一張</button>
        <button id="next" class="btn">下一張 →</button>
        <button id="rand" class="btn">隨機</button>
        <button id="reset" class="btn" title="清除此牌組的進度">重置進度</button>
      </div>
    </div>

    <!-- Starred board -->
    <div class="panel starsBoard">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div style="font-weight:900">加星清單</div>
      </div>
      <div class="tabs" id="starTabs">
        <button class="tab" data-tab="L1">L1</button>
        <button class="tab" data-tab="L2">L2</button>
        <button class="tab" data-tab="L3">L3</button>
        <button class="tab" data-tab="L4">L4</button>
        <button class="tab" data-tab="L5">L5</button>
        <button class="tab" data-tab="L6">L6</button>
        <button class="tab" data-tab="EXAM">學測</button>
      </div>
      <div id="starList" class="starList"></div>
    </div>

    <p class="muted" style="margin:14px 8px 0">已內建 CEEC 7000 六級單字＋學測單字。星與字體設定會保存於本機。</p>
  </div>

<script>
/** ---------- 基本設定 ---------- */
const FILES = {
  L1: 'CEEC_7000_Level1.json',
  L2: 'CEEC_7000_Level2.json',
  L3: 'CEEC_7000_Level3.json',
  L4: 'CEEC_7000_Level4.json',
  L5: 'CEEC_7000_Level5.json',
  L6: 'CEEC_7000_Level6.json',
  EXAM: 'CEEC_Exam.json',
};
const els = {
  deck: document.getElementById('deck'),
  q: document.getElementById('q'),
  onlyStar: document.getElementById('onlyStar'),
  card: document.getElementById('card'),
  word: document.getElementById('word'),
  kk: document.getElementById('kk'),
  def: document.getElementById('def'),
  counter: document.getElementById('counter'),
  starBtn: document.getElementById('starBtn'),
  slider: document.getElementById('slider'),
  idxL: document.getElementById('idxL'),
  idxR: document.getElementById('idxR'),
  prev: document.getElementById('prev'),
  next: document.getElementById('next'),
  rand: document.getElementById('rand'),
  reset: document.getElementById('reset'),
  starTabs: document.getElementById('starTabs'),
  starList: document.getElementById('starList'),
};
let dataCache = {};     // deck -> full array
let viewList = [];      // filtered list (search / onlyStar)
let curDeck = localStorage.getItem('deck') || 'L1';
let showTrans = JSON.parse(localStorage.getItem('showTrans') || 'false'); // 卡片是否顯示翻譯
let idx = 0;            // 當前 index（viewList 的）
const keyProg = d => `progress_${d}`;
const keyStars = 'stars_v2'; // { deck: { "word|kk": {w,kk,pos,def} } }

/** ---------- 輔助 ---------- */
const getStars = () => JSON.parse(localStorage.getItem(keyStars) || '{}');
const setStars = v => localStorage.setItem(keyStars, JSON.stringify(v));
const safeText = s => (s || '').toString();
function makeId(item){ return `${safeText(item.word)}|${safeText(item.kk)}`; }
function normalizeItem(raw){
  // 兼容不同欄位名稱
  return {
    word: raw.word || raw.en || raw.w || '',
    kk:   raw.kk || raw.phonetics || raw.ph || '',
    pos:  raw.pos || raw.type || raw.t || '',
    def:  raw.def || raw.cn || raw.zh || raw.c || '',
  };
}

/** ---------- 載入 & 建視圖 ---------- */
async function loadDeck(deck){
  if(!dataCache[deck]){
    const res = await fetch(FILES[deck], {cache:'no-store'});
    const arr = await res.json();
    dataCache[deck] = arr.map(normalizeItem);
  }
  buildView();
  // 恢復進度
  const saved = +localStorage.getItem(keyProg(deck)) || 1;
  idx = clamp(saved-1, 0, viewList.length-1);
  updateSlider();
  render();
  refreshStarList();
}
function buildView(){
  const all = dataCache[curDeck] || [];
  const stars = getStars();
  const starSet = new Set(Object.keys(stars[curDeck] || {}));
  const q = els.q.value.trim().toLowerCase();
  viewList = all.filter((it)=>{
    const id = makeId(it);
    if(els.onlyStar.checked && !starSet.has(id)) return false;
    if(!q) return true;
    const blob = (it.word + ' ' + it.def + ' ' + it.pos + ' ' + it.kk).toLowerCase();
    return blob.includes(q);
  });
  if(viewList.length===0){ viewList=[{word:'（無結果）',kk:'',pos:'',def:'請調整搜尋或條件'}]; }
  els.slider.max = String(viewList.length);
  els.idxR.textContent = String(viewList.length);
}
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

/** ---------- 畫面 ---------- */
function render(){
  const it = viewList[idx] || {word:'',kk:'',pos:'',def:''};
  els.word.textContent = it.word || '';
  els.kk.textContent = it.kk ? `[${it.kk}]` : '';
  els.def.textContent = [it.pos, it.def].filter(Boolean).join(' ');
  // 顯示/隱藏 翻譯
  els.kk.classList.toggle('hidden', !showTrans);
  els.def.classList.toggle('hidden', !showTrans);
  // 進度
  els.counter.textContent = `${idx+1} / ${viewList.length}`;
  els.idxL.textContent = String(idx+1);
  els.slider.value = String(idx+1);
  // 星號顯示
  const stars = getStars();
  const id = makeId(it);
  const on = Boolean(stars[curDeck] && stars[curDeck][id]);
  els.starBtn.textContent = on ? '★' : '☆';
  // 存進度（每次 render 視為瀏覽）
  localStorage.setItem(keyProg(curDeck), String(idx+1));
  // 記住翻譯可見狀態
  localStorage.setItem('showTrans', JSON.stringify(showTrans));
}
function updateSlider(){
  els.idxR.textContent = String(viewList.length);
  els.idxL.textContent = String(idx+1);
  els.slider.max = String(viewList.length);
  els.slider.value = String(idx+1);
}

/** ---------- 星號清單 ---------- */
function refreshStarList(tabKeep){
  const stars = getStars();
  // 啟用當前分頁樣式
  const active = tabKeep || (localStorage.getItem('starTab') || 'L1');
  [...els.starTabs.querySelectorAll('.tab')].forEach(b=>{
    b.classList.toggle('active', b.dataset.tab === active);
  });
  localStorage.setItem('starTab', active);

  const group = stars[active] || {};
  const list = Object.values(group); // {w,kk,pos,def}
  els.starList.innerHTML = '';
  if(list.length===0){
    const p = document.createElement('div');
    p.className='muted'; p.style.padding='6px 2px';
    p.textContent = '（此分級尚無加星單字）';
    els.starList.appendChild(p);
    return;
  }
  list.forEach((it)=>{
    const item = document.createElement('div');
    item.className='starItem';
    item.innerHTML = `
      <b>${safeText(it.word)}</b>
      <div class="muted" style="margin:4px 0">${it.kk?`[${safeText(it.kk)}]`:''}</div>
      <div>${[safeText(it.pos), safeText(it.def)].filter(Boolean).join(' ')}</div>
    `;
    item.addEventListener('click', ()=>{
      // 點清單 → 跳到該單字（若不同牌組會自動切換）
      if(curDeck !== it.deck){
        els.deck.value = it.deck;
        handleDeckChange();
        return;
      }
      // 在同牌組內尋找第一個匹配位置
      const pos = viewList.findIndex(v => makeId(v) === makeId(it));
      if(pos >= 0){ idx = pos; render(); updateSlider(); window.scrollTo({top:0,behavior:'smooth'}); }
    });
    els.starList.appendChild(item);
  });
}

/** ---------- 事件 ---------- */
function handleDeckChange(){
  curDeck = els.deck.value;
  localStorage.setItem('deck', curDeck);
  loadDeck(curDeck);
}
els.deck.value = curDeck;
els.deck.addEventListener('change', handleDeckChange);

els.card.addEventListener('click', ()=>{
  // 點卡片切換 翻譯顯示/隱藏
  showTrans = !showTrans;
  render();
});

els.starBtn.addEventListener('click', (e)=>{
  e.stopPropagation();
  const it = viewList[idx];
  const stars = getStars();
  stars[curDeck] = stars[curDeck] || {};
  const id = makeId(it);
  if(stars[curDeck][id]) delete stars[curDeck][id];
  else stars[curDeck][id] = {...it, deck: curDeck};
  setStars(stars);
  render();
  refreshStarList();
});

els.prev.addEventListener('click', ()=>{ idx = clamp(idx-1,0,viewList.length-1); render(); updateSlider(); });
els.next.addEventListener('click', ()=>{ idx = clamp(idx+1,0,viewList.length-1); render(); updateSlider(); });
els.rand.addEventListener('click', ()=>{
  idx = Math.floor(Math.random()*viewList.length);
  render(); updateSlider();
});
els.reset.addEventListener('click', ()=>{
  localStorage.removeItem(keyProg(curDeck));
  idx = 0; render(); updateSlider();
});
els.slider.addEventListener('input', ()=>{ idx = +els.slider.value - 1; render(); });
els.slider.addEventListener('change', ()=>{ localStorage.setItem(keyProg(curDeck), String(idx+1)); });

els.q.addEventListener('input', ()=>{
  buildView();
  idx = 0;
  updateSlider();
  render();
});
els.onlyStar.addEventListener('change', ()=>{
  buildView();
  idx = 0;
  updateSlider();
  render();
});
els.starTabs.addEventListener('click', (e)=>{
  const btn = e.target.closest('.tab'); if(!btn) return;
  refreshStarList(btn.dataset.tab);
});

/** ---------- 啟動 ---------- */
(async function init(){
  try{
    await loadDeck(curDeck);
  }catch(err){
    els.word.textContent = '讀取資料失敗';
    els.def.textContent = String(err);
    els.kk.classList.remove('hidden');
    els.def.classList.remove('hidden');
  }
})();
</script>
</body>
</html>
