<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CEEC 英漢翻譯單字卡（行動版）</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<style>
  :root{
    --bg:#f6e8c8;      /* 背景米色 */
    --paper:#fffaf2;   /* 卡片奶油白 */
    --ink:#4a2e1a;     /* 深咖啡 */
    --ink-weak:#7b5a46;
    --accent:#e8cf9a;  /* 按鈕米金 */
    --ring:rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
  }
  .wrap{max-width:980px;margin:0 auto;padding:12px 12px 24px}

  /* 工具列（保留：搜尋、等級、只看加星） */
  .toolbar{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center}
  .search{
    width:100%;padding:10px 12px;border:1px solid var(--ring);border-radius:12px;background:#fff3dd;color:var(--ink);outline:none;
  }
  .sel{
    border:1px solid var(--ring);background:#fff3dd;color:var(--ink);padding:10px 12px;border-radius:12px;font-weight:700;
  }
  .flag{display:flex;gap:8px;align-items:center;justify-content:flex-end}
  .tiny{font-size:12px;color:var(--ink-weak)}

  /* 卡片（高度縮小一些，讓下方清單更大） */
  .card{
    position:relative;background:var(--paper);border-radius:18px;padding:14px 14px 16px;
    box-shadow:0 14px 30px rgba(0,0,0,.08);min-height:50vh;margin-top:12px;overflow:hidden;
  }
  .num{position:absolute;left:14px;top:10px;color:var(--ink-weak);font-size:12px;font-weight:700}
  .star{
    position:absolute;right:14px;top:8px;width:36px;height:36px;border-radius:50%;border:0;background:transparent;
    display:grid;place-items:center;cursor:pointer;
  }
  .star svg{width:22px;height:22px;fill:#c9c9c9}
  .star.active svg{fill:#f5c02e}

  /* 置中內容；點擊切換翻譯 */
  .cardBody{
    width:100%;min-height:32vh;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;
  }
  #front{font-weight:900;letter-spacing:.6px;margin:6px 0 8px;font-size:clamp(28px,8.5vw,56px);color:var(--ink)}
  #transBox{margin-top:6px;display:none;flex-direction:column;align-items:center}
  .kk{font-weight:800;color:#7a5337;margin-bottom:6px}
  #back{font-size:clamp(20px,4.6vw,34px);font-weight:900}
  .pos{color:var(--ink-weak);margin-top:3px}

  /* 進度滑桿 */
  .sliderRow{display:flex;align-items:center;gap:10px;margin-top:8px}
  .sliderRow input[type="range"]{flex:1;accent-color:#c9a86d}
  .pill{min-width:48px;text-align:center;background:#fff3dd;border:1px solid var(--ring);border-radius:10px;padding:6px 8px;font-weight:800;color:var(--ink)}

  /* 下方控制列 */
  .controls{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
  .ctlBtn{border:1px solid var(--ring);background:#fff3dd;color:var(--ink);padding:12px 8px;border-radius:12px;font-weight:900;text-align:center}
  @media (max-width:520px){.controls{grid-template-columns:repeat(4,1fr)}}

  /* 加星清單（高度拉大） */
  .starBoard{
    margin-top:12px;background:#fff3dd;border:1px solid var(--ring);border-radius:14px;padding:12px;
  }
  .boardHead{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{
    background:#f9e8c0;border:1px solid var(--ring);border-radius:999px;padding:6px 10px;font-weight:800;color:var(--ink);cursor:pointer
  }
  .tab.active{background:#e7cd99}
  .list{margin-top:10px;display:grid;grid-template-columns:1fr;gap:8px;max-height:380px;overflow:auto}
  .rowItem{
    background:#fff;border:1px solid var(--ring);border-radius:10px;padding:8px 10px;
    display:flex;flex-direction:column;gap:2px
  }
  .rowItem b{font-size:15px}
  .rowItem small{color:var(--ink-weak)}
  /* 搜尋無結果提示 */
  .empty{padding:10px;color:var(--ink-weak)}
</style>
</head>
<body>
<div class="wrap">

  <!-- 工具列 -->
  <div class="toolbar">
    <input id="search" class="search" type="search" placeholder="搜尋 英/中/詞性/KK…" />
    <select id="levelSel" class="sel" title="CEEC 等級">
      <option value="1">CEEC Level 1</option>
      <option value="2">CEEC Level 2</option>
      <option value="3">CEEC Level 3</option>
      <option value="4">CEEC Level 4</option>
      <option value="5">CEEC Level 5</option>
      <option value="6">CEEC Level 6</option>
    </select>
    <div class="flag">
      <label class="tiny" style="display:flex;gap:6px;align-items:center">
        <input id="onlyStar" type="checkbox"> 只看加星
      </label>
    </div>
  </div>

  <!-- 卡片（點白色區域切換翻譯） -->
  <div id="cardView" class="card" aria-live="polite">
    <div class="num tiny" id="cardNum">—</div>

    <button id="starBtn" class="star" title="加星/取消">
      <svg viewBox="0 0 24 24"><path d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.62L12 2 9.19 8.62 2 9.24l5.46 4.73L5.82 21z"/></svg>
    </button>

    <div id="cardBody" class="cardBody">
      <h2 id="front">Loading…</h2>
      <div id="transBox">
        <span id="kk" class="kk"></span>
        <div id="back"></div>
        <span id="pos" class="pos"></span>
      </div>
    </div>

    <div class="sliderRow">
      <span class="pill" id="nowPill">0</span>
      <input id="progress" type="range" min="1" max="1" value="1">
      <span class="pill" id="totalPill">0</span>
    </div>
  </div>

  <!-- 控制列 -->
  <div class="controls">
    <button id="prevBtn" class="ctlBtn">← 上一張</button>
    <button id="hideBtn" class="ctlBtn">隱藏翻譯</button>
    <button id="nextBtn" class="ctlBtn">下一張 →</button>
    <button id="randBtn" class="ctlBtn">隨機</button>
  </div>

  <!-- 加星清單（分 level） -->
  <div class="starBoard">
    <div class="boardHead">
      <b>加星清單</b>
      <div class="tabs" id="starTabs">
        <button class="tab active" data-lv="1">L1</button>
        <button class="tab" data-lv="2">L2</button>
        <button class="tab" data-lv="3">L3</button>
        <button class="tab" data-lv="4">L4</button>
        <button class="tab" data-lv="5">L5</button>
        <button class="tab" data-lv="6">L6</button>
      </div>
    </div>
    <div class="list" id="starList"><div class="tiny">尚未加星</div></div>
  </div>

  <div class="tiny" style="margin-top:10px;color:var(--ink-weak)">
    已內建 CEEC 7000 六級單字・加星與進度會保存於本機
  </div>
</div>

<script>
  // 檔案路徑
  const LEVEL_FILES = {
    1: "CEEC_7000_Level1.json",
    2: "CEEC_7000_Level2.json",
    3: "CEEC_7000_Level3.json",
    4: "CEEC_7000_Level4.json",
    5: "CEEC_7000_Level5.json",
    6: "CEEC_7000_Level6.json",
  };

  // DOM
  const $ = s => document.querySelector(s);
  const $front = $('#front'), $kk=$('#kk'), $back=$('#back'), $pos=$('#pos');
  const $cardNum=$('#cardNum'), $transBox=$('#transBox'), $starBtn=$('#starBtn'), $cardBody=$('#cardBody');
  const $levelSel=$('#levelSel'), $search=$('#search'), $onlyStar=$('#onlyStar');
  const $progress=$('#progress'), $nowPill=$('#nowPill'), $totalPill=$('#totalPill');
  const $starTabs=$('#starTabs'), $starList=$('#starList');

  // 狀態
  let level = +localStorage.getItem('ceec_level') || 1;
  let allCards=[], viewCards=[];
  let idx = +localStorage.getItem(progressKey(level)) || 0;   // 每級別單獨記錄
  let showTrans=false;
  let starSet = new Set(JSON.parse(localStorage.getItem('ceec_stars') || '[]')); // "lv::word"

  // 啟動
  $levelSel.value = String(level);
  loadLevel(level);

  // 事件：點卡片白色區切換翻譯
  $cardBody.addEventListener('click', (e)=>{
    // 避免點到星星或滑桿誤觸
    if(e.target.closest('#starBtn') || e.target.closest('.sliderRow')) return;
    showTrans = !showTrans; render();
  });
  $('#hideBtn').addEventListener('click', ()=>{ showTrans=false; render() });
  $('#nextBtn').addEventListener('click', ()=>{ if(!viewCards.length)return; idx=(idx+1)%viewCards.length; saveProgress(); showTrans=false; render() });
  $('#prevBtn').addEventListener('click', ()=>{ if(!viewCards.length)return; idx=(idx-1+viewCards.length)%viewCards.length; saveProgress(); showTrans=false; render() });
  $('#randBtn').addEventListener('click', ()=>{ if(!viewCards.length)return; idx=Math.floor(Math.random()*viewCards.length); saveProgress(); showTrans=false; render() });

  $levelSel.addEventListener('change', ()=>{ level=+$levelSel.value; localStorage.setItem('ceec_level', level); idx = +localStorage.getItem(progressKey(level)) || 0; loadLevel(level) });

  // 改善搜尋：即時、去除多空白、大小寫不敏感；清空回復
  let searchTimer=null;
  $search.addEventListener('input', ()=>{
    clearTimeout(searchTimer);
    searchTimer=setTimeout(()=> applyFilters(true), 80);
  });
  $onlyStar.addEventListener('change', ()=>{ applyFilters(true) });

  // 進度滑桿：滑動即看、放開即記住
  $progress.addEventListener('input', e=>{
    const v = Math.max(1, Math.min(viewCards.length, +e.target.value)) - 1;
    if(viewCards.length){ idx = v; render(false) }
  });
  $progress.addEventListener('change', ()=>{ saveProgress(); render() });

  // 星號
  $starBtn.addEventListener('click', ()=>{
    const it=viewCards[idx]; if(!it) return;
    const k = keyOf(level, it.en);
    if(starSet.has(k)) starSet.delete(k); else starSet.add(k);
    localStorage.setItem('ceec_stars', JSON.stringify([...starSet]));
    renderStarBoard();                // 更新清單
    if($onlyStar.checked){ applyFilters(false) }  // 只看加星時即時重算，但維持 idx
    render();
  });

  // 星號清單 tab
  $starTabs.addEventListener('click', e=>{
    const t = e.target.closest('.tab'); if(!t) return;
    [...$starTabs.children].forEach(btn=>btn.classList.remove('active'));
    t.classList.add('active');
    renderStarBoard(+t.dataset.lv);
  });

  // 快捷鍵
  window.addEventListener('keydown',(e)=>{
    if(e.target.matches('input,textarea,select')) return;
    if(e.key==='ArrowRight') $('#nextBtn').click();
    if(e.key==='ArrowLeft')  $('#prevBtn').click();
    if(e.key===' ') { e.preventDefault(); $cardBody.click(); }
  });

  // 工具函式
  function keyOf(lv,en){ return `${lv}::${en}` }
  function progressKey(lv){ return `ceec_progress_${lv}` }
  function saveProgress(){
    localStorage.setItem(progressKey(level), idx);
  }

  async function loadLevel(lv){
    try{
      const res = await fetch(LEVEL_FILES[lv], {cache:'no-store'});
      allCards = await res.json();
    }catch(e){ allCards=[] }
    applyFilters(false);
    renderStarBoard(); // 依目前 starSet 畫清單，預設看當前 level
    render();
  }

  function normalize(s){ return (s||'').toString().trim().toLowerCase().replace(/\s+/g,' ') }

  function applyFilters(resetToFirst){
    const q = normalize($search.value);
    const onlyStar = $onlyStar.checked;

    if(!allCards || !allCards.length){ viewCards=[] }
    else{
      viewCards = allCards.filter(it=>{
        if(onlyStar && !starSet.has(keyOf(level, it.en))) return false;
        if(!q) return true;
        const hay = normalize([it.en,it.zh,it.pos,it.kk].filter(Boolean).join(' '));
        return q.split(' ').every(k=> hay.includes(k));
      });
    }

    if(viewCards.length===0){
      viewCards=[{en:"（沒有符合的單字）", zh:"清除搜尋或換關鍵字", pos:"", kk:""}];
      idx=0; showTrans=true; // 直接顯示提示
    }else{
      if(resetToFirst){ idx=0 } else { idx = Math.min(idx, viewCards.length-1) }
      showTrans=false; // 篩選後回到只看英文
    }

    // 更新滑桿
    $progress.max = String(viewCards.length||1);
    $totalPill.textContent = String(viewCards.length||0);
  }

  function render(updateSlider=true){
    const it = viewCards[idx] || {en:"",zh:"",pos:"",kk:""};
    $front.textContent = it.en||'';
    $back.textContent  = it.zh||'';
    $pos.textContent   = it.pos||'';
    $kk.textContent    = it.kk || '';
    $kk.style.display  = it.kk ? 'block' : 'none';

    // 翻譯顯示/隱藏（預設隱藏；點卡面切換）
    $transBox.style.display = showTrans ? 'flex' : 'none';

    // 編號
    $cardNum.textContent = `${Math.min(idx+1, viewCards.length)} / ${viewCards.length}`;

    // 星號狀態
    if(starSet.has(keyOf(level, it.en))) $starBtn.classList.add('active');
    else $starBtn.classList.remove('active');

    // 滑桿顯示
    if(updateSlider){
      $nowPill.textContent = String(Math.min(idx+1, viewCards.length));
      $progress.value = String(Math.min(idx+1, viewCards.length));
    }
  }

  function renderStarBoard(tabLevel){
    const lv = tabLevel || level;
    [...$starTabs.children].forEach(btn=>{
      btn.classList.toggle('active', +btn.dataset.lv === lv);
    });

    const keys = [...starSet].filter(k => +k.split('::')[0]===lv)
                             .map(k => k.split('::')[1]);

    const draw = (arr)=>{
      const items = arr.filter(it=> keys.includes(it.en));
      if(!items.length){ $starList.innerHTML = '<div class="empty">尚未加星</div>'; return }
      $starList.innerHTML = items.map(it=>(
        `<div class="rowItem">
           <b>${it.en}</b>
           ${it.kk?`<small>${it.kk}</small>`:''}
           <div>${it.zh||''}</div>
           ${it.pos?`<small>${it.pos}</small>`:''}
         </div>`
      )).join('');
    };

    // 快取
    window._lvCache = window._lvCache || {};
    if(lv===level){ draw(allCards); return }
    if(window._lvCache[lv]){ draw(window._lvCache[lv]); return }
    fetch(LEVEL_FILES[lv], {cache:'no-store'})
      .then(r=>r.json())
      .then(arr=>{ window._lvCache[lv]=arr; draw(arr) })
      .catch(()=> $starList.innerHTML = '<div class="empty">讀取失敗</div>');
  }
</script>
</body>
</html>
